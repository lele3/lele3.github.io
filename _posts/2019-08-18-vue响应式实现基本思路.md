---
title: Vueå“åº”å¼ç³»ç»Ÿå®ç°åŸºæœ¬æ€è·¯
key: 20190818
tags: vue
---

<center><h1>Vueå“åº”å¼ç³»ç»Ÿå®ç°åŸºæœ¬æ€è·¯</h1></center>

åœ¨vueä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨watchç›‘å¬æ•°æ®çš„å˜åŒ–ï¼Œåƒä¸‹é¢ä»£ç ä¸€æ ·ã€‚

```javascript
const vm = new Vue({
  data: {
    a: 1
  }
})
vm.$watch('a', () => {
  console.log('aè¢«ä¿®æ”¹äº†')
})
vm.a = 2
```

å½“æ‰§è¡Œvm.a = 2çš„æ—¶å€™ï¼Œä¼šè¾“å‡º â€˜aè¢«ä¿®æ”¹äº†â€˜ï¼Œ ä½†è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Œæˆ‘å°†ä¸€æ­¥ä¸€æ­¥è®°å½•ä¸‹æ¥ï¼Œä½†æ­¤ç¯‡æ–‡ç« åªè®°å½•æ€è·¯ï¼Œå…·ä½“vueæ€ä¹ˆå®ç°è¿˜éœ€è¦çœ‹æºç ã€‚
<!--more-->


### æ€è€ƒ1. ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¿®æ”¹vm.açš„æ—¶å€™ï¼Œä¼šè§¦å‘watchå‡½æ•°ï¼Œ è¿›ä¸€æ­¥æ€è€ƒï¼Œä»€ä¹ˆæ—¶å€™æˆ‘ä»¬å¯ä»¥ç›‘å¬å¯¹è±¡å±æ€§çš„ä¿®æ”¹ï¼Ÿ

é¦–å…ˆæƒ³åˆ°çš„è‚¯å®šæ˜¯å¯¹è±¡çš„è®¿é—®å™¨å±æ€§å§ï¼Œå³`getter/setter`, å½“æˆ‘ä»¬è®¾ç½®å¯¹è±¡çš„æŸä¸ªå±æ€§æ—¶ï¼Œ ä¼šè§¦å‘`setter`è®¿é—®å™¨ï¼Œå½“ç„¶ï¼Œ es6çš„Proxyä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œ**æ®è¯´**vue3æ˜¯ç”¨Proxyé‡å†™çš„ã€‚å›åˆ°æ­£è½¨ï¼Œæ—¢ç„¶æˆ‘ä»¬èƒ½ç›‘å¬å¯¹è±¡å±æ€§çš„ä¿®æ”¹ï¼Œé‚£æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨`setter`ä¸­æ‰§è¡Œwatchçš„å›è°ƒå‡½æ•°ã€‚å³

```javascript
const data = {
  a: 1
}
Object.defineProperty(data, 'a', {
  set() {
    // æ‰§è¡Œwatchå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œ å³å›è°ƒå‡½æ•°
  },
  get() {
    
  }
})
$watch('a', () => {
  console.log('ä¿®æ”¹äº†a')
})
```



### æ€è€ƒ2ï¼š å¦‚ä½•åœ¨setterä¸­æ‰§è¡Œ$watchå‡½æ•°çš„å›è°ƒå‡½æ•°ï¼ˆåé¢ç§°ä¹‹ä¸º ä¾èµ–ï¼‰ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ€è€ƒå¦‚ä½•æ‰èƒ½æ”¶é›†åˆ°ä¾èµ–ï¼Œæ—¢ç„¶åœ¨setterä¸­æ‰§è¡Œæ”¶é›†åˆ°çš„ä¾èµ–ï¼Œç°åœ¨åªå‰©getterå‡½æ•°äº†ï¼Œé‚£æˆ‘ä»¬å°±åœ¨getterå‡½æ•°ä¸­æ”¶é›†ä¾èµ–ã€‚

```javascript
const dep = [] // æ”¶é›†ä¾èµ–çš„æ•°ç»„
const data = {
  a: 1
}
Object.defineProperty(data, 'a', {
  set() {
    // æ‰§è¡Œæ”¶é›†åˆ°çš„ä¾èµ–
    dep.forEach(fn =>  fn())
  },
  get() {
    dep.push(Target)
  }
})
```

ä»¥ä¸Šä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜

1. å½“æˆ‘ä»¬æ‰§è¡Œdata.açš„æ—¶å€™è¿”å›ä¼šè¿”å›undefinedï¼Œ ä¸ºä»€ä¹ˆå‘¢ï¼Œ å› ä¸ºæˆ‘ä»¬åœ¨å†™getterå‡½æ•°çš„æ—¶å€™ï¼Œæ²¡æœ‰å†™return

2. getterå‡½æ•°ä¸­çš„Targetæ˜¯ä»å“ªæ¥çš„ï¼Ÿ

æ ¹æ®ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ï¼Œ æˆ‘ä»¬å®Œå–„ä»¥ä¸Šä»£ç 

```javascript
const dep = [] // æ”¶é›†ä¾èµ–çš„æ•°ç»„
const data = {
  a: 1
}
let val = data.a // ç¼“å­˜å­—æ®µåŸæœ‰çš„å€¼
Object.defineProperty(data, 'a', {
  set(newVal) {
    if(newVal === val) return // å¦‚æœæ–°è®¾ç½®çš„å€¼å’Œæ—§å€¼æ˜¯ä¸€æ ·çš„ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
    val = newVal // æ–°å€¼è¦†ç›–æ—§å€¼
    // æ‰§è¡Œæ”¶é›†åˆ°çš„ä¾èµ–
    dep.forEach(fn =>  fn())
  },
  get() {
    dep.push(Target)
    return val
  }
})

let Target = null
function $watch(exp, fn) {
  Target = fn // å°†fnå­˜å‚¨åœ¨å˜é‡Targetä¸­
  data[exp]   // é€šè¿‡è¯»å–data[exp]çš„å€¼ï¼Œè§¦å‘getterï¼Œ ä»è€Œå°†fnï¼ˆä¾èµ–ï¼‰æ”¶é›†åˆ°depä¸­
}

```

å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆç¼“å­˜ä¸€ä¸‹data.açš„å€¼ï¼Œ ç„¶åå†åœ¨getterå‡½æ•°ä¸­è¿”å›

å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªèƒ½å¯¹$watchæ–¹æ³•ä¸‹æ‰‹äº†ï¼Œæˆ‘ä»¬é¦–å…ˆå°†fnå­˜å‚¨åˆ°Targetä¸­ï¼Œç„¶åé€šè¿‡data[exp]è§¦å‘getterå®Œæˆä¾èµ–æ”¶é›†ã€‚

```javascript
$watch('a', () => {
  console.log('aè¢«ä¿®æ”¹äº†')
})
data.a = 2
```

æ­¤æ—¶ï¼Œæ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œå°±ä¼šè§¦å‘$watchå‡½æ•°ï¼Œ è¾“å‡º `aè¢«ä¿®æ”¹äº†`



### æ€è€ƒ3ï¼šä»¥ä¸Šå®ç°åªèƒ½ç›‘å¬å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œé‚£ä¹ˆå¦‚ä½•ç›‘å¬å¤šä¸ªå±æ€§å‘¢ï¼Ÿ

å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨forå¾ªç¯æ¥éå†å¯¹è±¡ï¼Œé‡å¤æ‰§è¡Œä¸Šè¿°ä»£ç 

```javascript
const data = {
  a: 1,
  b: 2
}
for(let key in data) {
  const dep = [] // æ”¶é›†ä¾èµ–çš„æ•°ç»„, æ”¾åœ¨forå¾ªç¯é‡Œï¼Œè¿™ä¸ªæ¯ä¸€ä¸ªå±æ€§éƒ½ä¼šæœ‰è‡ªå·±çš„ä¾èµ–æ”¶é›†å™¨
  let val = data[key] // ç¼“å­˜å­—æ®µåŸæœ‰çš„å€¼
  Object.defineProperty(data, key, {
    set(newVal) {
      if(newVal === val) return // å¦‚æœæ–°è®¾ç½®çš„å€¼å’Œæ—§å€¼æ˜¯ä¸€æ ·çš„ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
      val = newVal // æ–°å€¼è¦†ç›–æ—§å€¼
      // æ‰§è¡Œæ”¶é›†åˆ°çš„ä¾èµ–
      dep.forEach(fn =>  fn())
    },
    get() {
      dep.push(Target)
      return val
    }
  })
}

let Target = null
function $watch(exp, fn) {
  Target = fn // å°†fnå­˜å‚¨åœ¨å˜é‡Targetä¸­
  data[exp]   // é€šè¿‡è¯»å–data[exp]çš„å€¼ï¼Œè§¦å‘getterï¼Œ ä»è€Œå°†fnï¼ˆä¾èµ–ï¼‰æ”¶é›†åˆ°depä¸­
}
```

å½“æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ä»£ç æ—¶, å‘ç°dataå¯¹è±¡çš„a,bå±æ€§éƒ½è¢«ç›‘å¬åˆ°äº†ã€‚

```javascript
$watch('a', () => {
  console.log('aè¢«ä¿®æ”¹äº†')
})
$watch('b', () => {
  console.log('bè¢«ä¿®æ”¹äº†')
})
data.a = 3
data.b = 4
```

### æ€è€ƒ4ï¼š ç›®å‰å·²ç»å®ç°äº†å¯¹å¯¹è±¡å¤šä¸ªå±æ€§çš„ç›‘å¬ï¼Œé‚£è¦æ˜¯é‡åˆ°åµŒå¥—å±æ€§çš„è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

å‡è®¾å¯¹è±¡dataæ˜¯å¦‚ä¸‹å½¢å¼

```javascript
const data = {
  a: {
    b: 1
  }
}
```

æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¾ç„¶æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œå‘ç°åªæœ‰aå±æ€§å¯ä»¥è¢«ç›‘å¬åˆ°ï¼Œè€Œbå±æ€§æ²¡æœ‰è¢«ç›‘å¬åˆ°ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥ç»§ç»­ä¿®æ”¹ä¸Šè¿°ä»£ç ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥ä¿®æ”¹$watchå‡½æ•°çš„ä¼ å‚ï¼Œæ—¢ç„¶å®ƒæ˜¯åµŒå¥—çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›‘å¬bå±æ€§æ˜¯ä¸æ˜¯åº”è¯¥å†™æˆ

```javascript
$watch('a.b', () => {
  console.log('bè¢«ä¿®æ”¹äº†')
})
data.a.b = 2
```

å‘ç°è¿˜æ˜¯æ²¡æœ‰ç”Ÿæ•ˆğŸ˜‚ï¼Œä»”ç»†è§‚å¯Ÿï¼Œè¿™æ®µä»£ç æ˜¯æœ‰é—®é¢˜çš„

é¦–å…ˆï¼Œ ä¼ é€’çš„å‚æ•°'a.b'æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒä¸å¯èƒ½ç›‘å¬åˆ°`a.b`çš„å˜åŒ–ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¦è§£æè¿™ç§å¸¦`.`çš„å­—ç¬¦ä¸², ä¿®æ”¹$watchå‡½æ•°å¦‚ä¸‹

```javascript
let Target = null
function $watch(exp, fn) {
  Target = fn
  let obj = data
  if(/\./.test(exp)) { // åˆ¤æ–­ä¼ é€’çš„å‚æ•°ä¸­æ˜¯å¦åŒ…å«.
    let pathArr = exp.split('.') // è·å–åˆ°åµŒå¥—å±æ€§çš„æ•°ç»„ï¼Œä»¥'a.b'ä¸ºä¾‹ï¼Œå¾—åˆ°[a, b]
    pathArr.forEach(key => {
      obj = obj[key] // å¾ªç¯è·å–åˆ°obj.a.b
    })
    return
  }
  obj[exp]
}
```

è¿˜è®°å¾—$watchå‡½æ•°çš„ä¸¤ä¸ªä½œç”¨å—ï¼Ÿ 

1. é€šè¿‡Targetå˜é‡å­˜å‚¨ä¾èµ–

2. é€šè¿‡è¯»å–å±æ€§å€¼è§¦å‘è®¿é—®å™¨å±æ€§getter,å®Œæˆä¾èµ–æ”¶é›†

æ‰€ä»¥ï¼Œ å¦‚ä¸Šä»£ç ï¼Œ å½“ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¸¦æœ‰`.`çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆéå†ï¼Œç›´åˆ°è¯»å–åˆ°æœ€åä¸€ä¸ªå±æ€§ï¼Œè§¦å‘getterï¼Œå®Œæˆä¾èµ–æ”¶é›†ï¼Œä¹‹åreturnï¼Œä¸æ‰§è¡Œåé¢çš„ä»£ç ã€‚

ä¿®æ”¹$watchå‡½æ•°ä»¥åï¼Œæˆ‘ä»¬å¯ä»¥å†è¯•è¯•ï¼Œå‘ç°è¿˜æ˜¯ä¸å¯ä»¥ï¼Œé‚£é—®é¢˜å‡ºåœ¨å“ªå‘¢ï¼Ÿ

ä»£ç å°±è¿™ä¹ˆä¸¤éƒ¨åˆ†ï¼Œ$watchå‡½æ•°å·²ç»ä¿®æ”¹äº†ï¼Œæ²¡èƒ½äº§ç”Ÿæˆ‘ä»¬é¢„æœŸçš„ç»“æœï¼Œé‚£è¯´æ˜å¦ä¸€éƒ¨åˆ†çš„ä»£ç ä¹Ÿéœ€è¦ä¿®æ”¹ï¼Œå›é¡¾ä»£ç 

```javascript
for(let key in data) {
  const dep = [] // æ”¶é›†ä¾èµ–çš„æ•°ç»„, æ”¾åœ¨forå¾ªç¯é‡Œï¼Œè¿™ä¸ªæ¯ä¸€ä¸ªå±æ€§éƒ½ä¼šæœ‰è‡ªå·±çš„ä¾èµ–æ”¶é›†å™¨
  let val = data[key] // ç¼“å­˜å­—æ®µåŸæœ‰çš„å€¼
  Object.defineProperty(data, key, {
    set(newVal) {
      if(newVal === val) return // å¦‚æœæ–°è®¾ç½®çš„å€¼å’Œæ—§å€¼æ˜¯ä¸€æ ·çš„ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
      val = newVal // æ–°å€¼è¦†ç›–æ—§å€¼
      // æ‰§è¡Œæ”¶é›†åˆ°çš„ä¾èµ–
      dep.forEach(fn =>  fn())
    },
    get() {
      dep.push(Target)
      return val
    }
  })
}
```

è¯¶è¯¶è¯¶ï¼Œæˆ‘å¥½åƒå‘ç°äº†ä»€ä¹ˆã€‚æˆ‘ä»¬çš„forå¾ªç¯åªèƒ½å¾ªç¯å‡ºæ¥ç¬¬ä¸€å±‚å¯¹è±¡å±æ€§å•Šï¼Œå¯¹äºåµŒå¥—å±æ€§æ²¡è¾™å•Šã€‚æ‰€ä»¥ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€’å½’å•Š

```javascript
function walk(data) {
  for(let key in data) {
    const dep = []
    let val = data[key]
    if(Object.prototype.toString.call(val) === '[object Object]') {
      walk(val)
    }
    Object.defineProperty(data, key, {
      set(newVal) {
        if(newVal === val) return
        val = newVal
        dep.forEach(fn => fn())
      },
      get() {
        dep.push(Target)
        return val
      }
    })
  }
}
walk(data)
```

æˆ‘ä»¬å†æ¬¡æ‰§è¡Œå¦‚ä¸‹ä»£ç 

```javascript
$watch('a.b', () => {
  console.log('bè¢«ä¿®æ”¹äº†')
})
data.a.b = 2
```

è¯¶ï¼æ€ä¹ˆè¿™ä¹ˆç¥å¥‡å‘¢ï¼Œå®ƒæŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„è¾“å‡ºäº†ã€‚



### æ€è€ƒ5ï¼š æˆ‘ä»¬åœ¨å†™Vueä»£ç çš„æ—¶å€™ï¼Œåœ¨templateæ¨¡æ¿é‡Œè¯»å–dataé‡Œçš„å˜é‡ï¼Œä¼šä¸ä¼šè§¦å‘ä¾èµ–æ”¶é›†å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé‚£å®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿé¦–å…ˆtemplateæ¨¡æ¿ä¼šè¢«å¤„ç†æˆrenderå‡½æ•°ï¼Œç„¶åæ‰§è¡Œrenderå‡½æ•°å»å®Œæˆé¡µé¢çš„æ¸²æŸ“ï¼Œå…·ä½“çš„å®ç°é€»è¾‘è¿˜è¯·å‚ç…§vueæºç ï¼Œå› ä¸ºæˆ‘ç›®å‰ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼ˆTODOï¼‰ï¼Œæ—¢ç„¶å®ƒæ˜¯ä¸ªå‡½æ•°ï¼Œé‚£æˆ‘ä»¬çš„$watch å‡½æ•°æ˜¯ä¸æ˜¯ä¹Ÿåº”è¯¥å¯ä»¥æ¥æ”¶å‡½æ•°ä½œä¸ºå‚æ•°

```javascript
const data = {
	name: 'simple',
	age: 22
}
function render() {
	document.write(`hello, my name is ${data.name}, I am ${data.age} years old this year.`)
}

let Target = null
function $watch(exp, fn) {
	Target = fn
  let obj = data
  if(typeof exp === 'function') {
    exp()
    return
  }
  if(/\./.test(exp)) {
    let pathArr = exp.split('.')
    pathArr.forEach(key => {
      obj = obj[key]
    })
    return
  }
  return obj[key]
}
```

æˆ‘ä»¬é¦–å…ˆåˆ¤æ–­expæ˜¯ä¸æ˜¯å‡½æ•°ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œåˆ™ç›´æ¥æ‰§è¡Œå‡½æ•°ï¼Œå®Œæˆä¾èµ–æ”¶é›†ï¼Œåé¢ä»£ç ä¸å†æ‰§è¡Œã€‚åŒæ—¶æˆ‘ä»¬è¦æ³¨æ„ä¼ é€’ç»™$watchå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°

```javascript
$watch(render, render)
```

ç¬¬äºŒä¸ªå‚æ•°ä¾ç„¶æ˜¯render,å³å½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé‡æ–°æ‰§è¡Œrenderå‡½æ•°ï¼Œæˆ‘ä»¬å°±å®ç°äº†æ•°æ®å˜åŒ–ï¼Œå¹¶å°†å˜åŒ–åº”ç”¨åˆ°DOMä¸Šã€‚

### æ€»ç»“

ä»¥ä¸Šï¼Œå¤§æ¦‚å°±æ˜¯vueå“åº”å¼ç³»ç»Ÿçš„åŸºæœ¬æ€è·¯ï¼Œä½†æ˜¯æˆ‘ä»¬å®ç°çš„éƒ½æ˜¯æœ€ç®€å•çš„ï¼Œæœ‰å¾ˆå¤šä¸å®Œå–„çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼Œå¦‚ä½•é¿å…é‡å¤æ”¶é›†ä¾èµ–ï¼Œå¦‚ä½•å¤„ç†æ•°ç»„ä»¥åŠå…¶ä»–è¾¹ç•Œæ¡ä»¶ç­‰ç­‰ã€‚

ä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç 

```javascript
function walk(data) {
  for(let key in data) {
    const dep = []
    let val = data[key]
    if(Object.prototype.toString.call(val) === '[object Object]') {
      walk(val)
    }
    Object.defineProperty(data, key, {
      set(newVal) {
        if(newVal === val) return
        val = newVal
        dep.forEach(fn => fn())
      },
      get() {
        dep.push(Target)
        return val
      }
    })
  }
}
walk(data)

let Target = null
function $watch(exp, fn) {
	Target = fn
  let obj = data
  if(typeof exp === 'function') {
    exp()
    return
  }
  if(/\./.test(exp)) {
    let pathArr = exp.split('.')
    pathArr.forEach(key => {
      obj = obj[key]
    })
    return
  }
  return obj[key]
}
```





å‚è€ƒï¼š https://github.com/HcySunYang/vue-design/tree/elegant



